# MCP Custom Connector Tool Visibility Analysis

## Problem
The Custom Connector connects successfully ("MCP connected"), but shows "zero tools" available.
Server-side logs confirm that `tools/list` is being called and returning a list of tools, but the client (Claude.ai Custom Connector) ignores them.

## Root Cause Analysis
After inspecting the generated `inputSchema` for the tools, we identified **Schema Format Incompatibility** as the root cause.

### 1. Complex `anyOf` Structures
FastMCP uses Pydantic to generate JSON Schemas from Python type hints. For optional arguments (e.g., `project: Optional[str] = None`), Pydantic generates:
```json
"project": {
  "anyOf": [
    { "type": "string" },
    { "type": "null" }
  ],
  "default": null,
  "title": "Project"
}
```
While valid in newer JSON Schema drafts, this structure is often rejected by stricter or older validators, or by LLM tool definition parsers that expect a simpler `type: ["string", "null"]` or just `type: "string"` (with the field omitted from `required`).

### 2. Excessive Metadata (`title`)
Pydantic adds a `title` field to every property definition. This adds significant noise to the schema and increases token count, but more importantly, some validators may be strict about unexpected fields or get confused by them.

### 3. Explicit `default: null`
The schema includes `"default": null`. Some systems distinguish between "undefined" and "null", and passing `null` as a default might cause type errors if the system expects a string.

## Verification
We used `verify_tools.py` to inspect the raw schemas generated by FastMCP.
- **Before Fix**: Schemas contained nested `anyOf`, `title` fields, and `default: null`.
- **Hypothesis**: Simplifying these schemas to standard, flat JSON Schema would resolve the visibility issue.

## Applied Fix
We implemented a monkey-patching solution to clean the schemas at runtime, before the server starts.

### 1. `schema_patcher.py`
A new utility module that recursively walks the tool schemas and:
- Removes all `title` fields.
- Converts `anyOf: [{type: T}, {type: null}]` to `type: [T, "null"]`.
- Removes `default: null`.

### 2. `server_hosted.py` Integration
Modified the server startup sequence to apply the patch:
```python
# PATCH: Fix schema compatibility for Custom Connector
try:
    from schema_patcher import patch_mcp_tools
    patch_mcp_tools(mcp)
except Exception as e:
    logger.error("patching_tool_schemas_failed", error=str(e))

app = mcp.streamable_http_app()
```

## Resulting Schema
The schema for `semantic_search_contexts` (complex example) was transformed:

**From:**
```json
"priority": {
  "anyOf": [
    { "type": "string" },
    { "type": "null" }
  ],
  "default": null,
  "title": "Priority"
}
```

**To:**
```json
"priority": {
  "type": ["string", "null"]
}
```

This simplified format is widely compatible and should be accepted by the Custom Connector.

## Next Steps
1. **Deploy** the updated `server_hosted.py` and `schema_patcher.py`.
2. **Verify** in Claude.ai Custom Connector.
   - Connect to the server.
   - Check if tools now appear.
